---
title: "Packages, functions and tricks in R"
author: "Victor Z. Nygaard"
header-includes:
   - \usepackage[utf8]{inputenc}
   - \usepackage{verbatim}
   - \usepackage[language]{babel}
   - \usepackage[encoding]{inputenc}
   - \usepackage{hyperref}
   - \usepackage{amsmath}
   - \usepackage{mathtools}
   - \usepackage{amssymb}
   - \usepackage{mathtools}
   - \usepackage{nicefrac}
   - \usepackage{fullpage}
   - \usepackage{stmaryrd}
   - \usepackage{aligned-overset}
   - \usepackage{pdfpages}
date: "Last compiled on `r format(Sys.time(), '%d. %B, %Y')`"
# Hvordan får  vi den til at printe February i stedet for februar??????
output: html_document
---

------------------------------------------------------------------------

```{=html}
<!-- RMD/RStudio tips:
1. CTRL+SHIFT+C RMD-comments-out the selected lines, with in a standard HTML comment-out format. 

2. CTRL+ALT+I inserts a new r codechunck

3. Pressing CTRL+SHIFT+ENTER when over a code chunck gives you a preview of the results of the chunck

4. CTRL+SHIFT+K gives you a preview of the entire resulting HTML file.

5. Note the different results of '#HS 1' and 
'# HS 1' (without the '') in the output

6. It is possible to compile regular R-scripts into Rmd files - this is done by pressing CTRL+SHIFT+K while attending any R-script. <<<- Though this apparently doesn't work for HS Problems.R for some reason!?!?!? ->>>

7. Selective use of the echo=c(...) option within code chuncks allows assignment of a variable, to show the assignment in the knitted document, and showing the value of the assignment seamlessly as well - see HS2.3

8. It is possible to include results of R-analysis such as summary statistics in LaTeX-equations in RMD, see HS2.3

9. Adding fig.align="center" to a code chunk centers any figures generated by the chunck.

9.1 note that properties of codechunks seem casesensitive; fig.align="center" centers a figure, but fig.align="Center" (with capital C) doesn't

10. A new subtitle needs a blank line before itself: 
'works:

#### HS 7
'

'doesn't:
blablabla
#### HS 7
'

'doesn't either:
<!-- blablabla ->
#### HS 7
'
11. Pressing F7 when marking, or hovering over a word will spellcheck the word

12. CTRL + - (minus) zooms out, CTRL + + (plus) zooms in

13. CTRL + D Deletes the current line, or current selection of lines

14.    THE FOLLOWING SOURCE EDITOR FOLDING METHODS:
14.1   Collapse current fold: ALT + L
14.1.1 Expand current fold: SHIFT + ALT + L
14.2   Collapse "all" subfolds: ALT + O <- !?!! Note that this leaves a small letter 'o' in the text !!?!
14.2.1 Expand "all" subfolds: SHIFT + ALT + O
14.3   Collapse all other folds: ALT + 0 (zero)

15. SHIFT + ALT + J allows you to jump to specific parts of the document

16. Writing a new line with '...' will cause all previous output to be hidden in the knittet document

17. 

18. Note that 'attach' only has the scope of the current R-chunck.

19. One way to get pdf printout is to compile a html-printout, and then, in-browser, 'print' the HTML page      as a pdf.

20. CTRL + SHIFT + M gives the pipe operator.

21. Pressing CTRL + F3 searches on the selected word.

22. ALT + SHIFT + DOWN copies a line to below.

23. CTRL + ALT + K highlights all similar words in block for editing.

24. One might consider switching to Quarto documents as opposed to rmd: https://quarto.org/docs/computations/r.html
-->
```

```{=html}
<!-- R tips:

1. Writing (q<-5) around R code, will both assign and print the code upon assignment 

2. `utils::browseURL(getwd())` opens the working directory, or file location if run in file, using windows explorer

3. The conflicted package gives warnings when called function names appear in multiple namespaces

4. options() provides various global parameters that one may change for the R session.

5. rm() gives you the ability to deallocate memory for a stored R-object, such as a variable

6. ?scale_colour_discrete showcases a way of changing default colour scheme of ggplot

7. Do not use %>% magrittr pipe for standard R functions. Try for example exp(4.1+0.33*log(10^6))
   vs. 4.1+0.33*log(10^6) %>% exp()
-->
```

```{=html}
<!-- git/shell tips:

1. `git commit -a -m "commit message"` as implemented within the (git) terminal (can be accessed within the git menu in RStudio via the "More" (gear icon)) commits all (-a) files within the perview of git using the message (-m) "commit message"

2. `git push` as implemented within the (git) terminal pushes the commit, as standard and when in a RProject, to the repository's main branch, unless otherwise specified.

3. mv 'filename_old' 'filename_new' used within the shell/terminal will change the name of a file.
-->
```

<!-- ---?--- How do I create a closeable Rmd section, such that I do not have to scroll through the LaTeX commands each time? - !!! Can be done with '-----' through this also creates a line in the knittet document. -->

<!-- How do I publish and share the HTML as a viewable (and linkable) website - this can be done through github? -->

<!-- How can I share R markdown files such that multiple people can edit them at the same time? -->

<!-- Do we need parindent controls as in LaTeX? -->

<!-- Use of the cache function to reduce recompile times -->

<!-- How to close current subsection with a keyboard shortcut? How to close subsubsections,...? - !!!See RMD tip 14!!! -->

<!-- Chunk naming? -->

<!-- How to define variables such that they have scope within their own ## segment? -->

<!-- How do I delete all non-needed variables for each new section in R??? -->

<!-- LaTeX commands -->

\newcommand{\C}{\mathbb{C}}

<!--- Komplekse tal --->

\newcommand{\R}{\mathbb{R}}

<!--- Reelle tal--->

\newcommand{\Q}{\mathbb{Q}}

<!---Rationelle tal--->

\newcommand{\Z}{\mathbb{Z}}

<!---Hele tal--->

\newcommand{\N}{\mathbb{N}}

<!---Naturlige tal--->

\newcommand{\E}{\mathbb{E}}

<!---mean--->

\newcommand{\F}{\mathbb{F}}

<!---Baggrundsrum sigma-alg--->

\newcommand{\B}{\mathbb{B}}

<!---Borel sigma--->

\newcommand{\K}{\mathbb{K}}

<!---Generel field--->

\newcommand{\RB}{\overline{\R}}

<!---Udvidede reelle tal--->

\newcommand{\ms}[1]{\mathscr{#1}}
\newcommand{\mc}[1]{\mathcal{#1}}


\newcommand{\mf}[1]{\mathfrak{#1}}


<!---Arrows -->

\newcommand{\ra}{\rightarrow}

<!---Konvergens pil højre -->

\newcommand{\nra}{\nrightarrow}

<!---ikke Konvergens pil højre -->

\newcommand{\la}{\leftarrow}

<!---Konv pil venstre -->

\newcommand{\nla}{\nleftarrow}

<!---ikke Konvergens pil venstre -->

\newcommand{\lra}{\leftrightarrow}

<!---højre venstre pil -->

\newcommand{\nlra}{\nleftrightarrow}

<!---ikke højre venstre pil -->

\newcommand{\hra}{\hookrightarrow}

<!---Injektiv  pil højre -->

\newcommand{\Ra}{\Rightarrow}

<!---Implikations pil højre -->

\newcommand{\Lra}{\Leftrightarrow}

<!---Bi-implikations pil -->

\newcommand{\Uda}{\Updownarrow}

<!---Bi-implikations pil (op og ned) -->

\newcommand{\Da}{\Downarrow}

<!---implikations pil (ned) -->


\newcommand{\inse}{\overset{\cdot}{=}} <!--- Insert values in calculation -->

\newcommand{\eqd}{\overset{d.}{=}}

<!--- Parenteser --->

\newcommand{\lrp}[1]{\mathopen{}\left({#1}\right)\mathclose{}}

<!-- \left("STUFF"\right) -->

\newcommand{\lrc}[1]{\mathopen{}\left\{{#1}\right\}\mathclose{}}

<!-- \left\{"STUFF"\right\} -->

\newcommand{\lrs}[1]{\mathopen{}\left[{#1}\right]\mathclose{}}

<!-- \left["STUFF"\right] -->

\newcommand{\lrb}[1]{\mathopen{}\left|{#1}\right|\mathclose{}}

<!-- \left|"STUFF"\right| -->

\newcommand{\inner}[2]{\mathopen{}\left\langle #1, #2 \right\rangle\mathclose{}}

<!-- <\left"STUFF1","STUFF2"\right> -->

\newcommand{\norm}[1]{\mathopen{}\left\lVert#1\right\rVert\mathclose{}}

<!-- \left||"STUFF"\right|| -->

\newcommand{\floor}[1]{\lfloor #1 \rfloor}

<!---Floor function --->

\newcommand{\ceil}[1]{\lceil #1 \rceil}

<!---ceil --->

<!--- Farver --->

\newcommand{\blue}[1]{\textcolor{blue}{{#1}}}

<!--- Turning text blue --->

\newcommand{\red}[1]{\textcolor{red}{{#1}}}

<!--- Turning text red --->

\newcommand{\green}[1]{\textcolor{green}{{#1}}}

<!--- Turning text green --->

\newcommand{\purple}[1]{\textcolor{purple}{{#1}}}

<!--- Turning text purple --->

\newcommand{\cyan}[1]{\textcolor{cyan}{{#1}}}

<!--- Turning text cyan --->

\newcommand{\orange}[1]{\textcolor{orange}{{#1}}}

<!--- Turning text orange --->

<!--- Oversetting bold accents --->

\newcommand{\boldhat}[1]{\mathbf{\hat{\text{$#1$}}}}
\newcommand{\boldbar}[1]{\mathbf{\bar{\text{$#1$}}}}
\newcommand{\boldtilde}[1]{\mathbf{\tilde{\text{$#1$}}}}
\newcommand{\boldcheck}[1]{\mathbf{\check{\text{$#1$}}}}
\newcommand{\indep}{\perp \!\!\! \perp}

<!---independence --->


\newcommand{\colvec}[1]{\begin{pmatrix}{#1}\end{pmatrix}}

<!-- Begin column vector - Doesn't seem to work with non-column vectors...-->

\newcommand{\nd}[2]{\mc{N}\lrp{{#1},{#2}}}

<!-- Normal distribution -->

\newcommand{\dnd}[2]{\sim\mc{N}\lrp{{#1},{#2}}}

<!-- Distributed as Normal distribution -->

\newcommand{\wnd}[3]{\frac{1}{\sqrt{2\pi\cdot {#3}}}e^{-\frac{1}{2}\frac{\lrp{{#1}-{#2}}^2}{{#3}}}}

<!-- With normal density (prob = #1, mean = #2, variance = #3 -->

<!-- \newcommand{\Rlogo}{![](../Data/R_logo.png){#id .class width=auto height=16px} } <!-- R logo implemented in text -->

<!-- Image insertion alla LaTeX doesn't seem to work too well..., but inserting the above gives the desired effect. -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(fig.align = 'center')
options(warnPartialMatchDollar = TRUE) #see ADV-R chapter 4.3.2
library(tidyverse)
library(gridExtra)
theme_set(theme_minimal())
library(MASS) #Has a conflict with dplyr regarding select.
library(reshape2)
library(caret) #Used for Machine Learning
#library(plot.matrix) 
library(Matrix)
library(expm)
#library(plotly) #for 3D plotting
#library(reticulate) #Used for saving plotly images
#library(nloptr) #optimisation
#library(lpSolve) #linear programming
library(microbenchmark)
library(scales) #used for log trans of ggplot
#library(stats4) #mle and stuff

## warnings when calling functions present in multiple namespaces
## use conflict_scout() to scout conflicts in current session
library(conflicted) 
conflict_prefer(name = "select", winner = "dplyr", losers = "MASS")

### For Regression course:
library(ggplot2)   ## Grammar of graphics
library(reshape)   ## Reshaping data frame
library(lattice)   ## More graphics
library(hexbin)    ## and more graphics
library(gridExtra) ## ... and more graphics (placing graphs adjacent)
library(latex2exp) ## ... (writing latex symbols in ggplot)
library(xtable)    ## LaTeX formatting of tables
library(splines)   ## Splines
library(survival)  ## Survival analysis
library(grid)      ## For `unit`
library(lpSolve)   ## Linear programming
#library(RwR)       ## Regression with R dataset-package

set.seed(314)
```


```{r}
beta0 <- -1
beta1 <- 0.1
beta2 <- 3
beta_c <- c(beta0,beta1,beta2)
X_i <- c(1,0,2)
X_j <- c(1,1,2)
exp(X_i%*%beta_c)
exp(X_j%*%beta_c)
exp(X_j%*%beta_c)/exp(X_i%*%beta_c)
```


```{r}
data.y <- read.table("http://www.math.ku.dk/~susanne/data1.txt", header = TRUE)
data.y %>% head()
```

```{r}
model_lm <- lm(Y~X1+X2+X3, data = data.y)
summary(model_lm)
```
```{r}
(coeffs <- as.numeric(coef(model_lm)))
coeffs[1] + -1*coeffs[2] + 1*coeffs[3] + 0.1*coeffs[4]
```

```{r}
model_lm_ns <- lm(Y ~ ns(X1, df = 3) + X2 + ns(X3, df = 3), data = data.y)
summary(model_lm_ns)
```

```{r}
nsdiag <- fortify(model_lm_ns)
nsdiag %>% names()
nsdiag %>% ggplot(aes(x = .fitted, y = .stdresid)) +
  geom_point() + 
  geom_smooth()
```

```{r}
nsdiag %>% head()
nsdiag_x1x3 <- cbind(nsdiag, X1 = data.y$X1, X3 = data.y$X3)
nsdiag_x1x3 %>% names()
nsdiag_x1x3 %>% ggplot(aes(x = X1, y = .stdresid)) +
  geom_point() + 
  geom_smooth()
```


```{r}
nsdiag_x1x3 %>% ggplot(aes(x = X3, y = .stdresid)) +
  geom_point() + 
  geom_smooth()
```

```{r}
anova(model_lm, model_lm_ns)
```


Second model:
```{r}
data.y_cat <- read.table("http://www.math.ku.dk/~susanne/data1.txt", header = TRUE, colClasses = c("double", "double", "character", "double"))
data.y_cat %>% head()
```

```{r}
model_lm_cat <- lm(Y~X1+X2+X3, data = data.y_cat)
summary(model_lm_cat)
```




<!-- ####### -->
```{r}
claims <- read.table("http://www.math.ku.dk/~richard/regression/data/claims.txt", sep = ";", colClasses = c("character", "numeric", "numeric", "factor")) 
```


```{r}
claims_red <- claims[1:(nrow(claims)-1000),]
```

```{r}
nrow(claims_red)
```

```{r}
add_lm <- lm(log(claims) ~ log(sum) + grp, data = claims_red)
summary(add_lm)
coef(add_lm)
```

```{r}
int_lm <- lm(log(claims) ~ log(sum)*grp, data = claims_red)
summary(int_lm)
```

```{r}
anova(int_lm, add_lm)
```

```{r}
drop1(int_lm, test = "F")
```

```{r}
plot(add_lm)
```

```{r}
add_lm_rst <- rstandard(add_lm)
cbind(rst = add_lm_rst, log_sum = I(log(claims_red$sum))) %>% as_tibble() -> log_sum_rst
```

```{r}
log_sum_rst %>% ggplot(aes(x = log_sum, y = rst)) + geom_point() + geom_smooth()
```

```{r}
coef(add_lm)
coef(add_lm)[[1]]+coef(add_lm)[[2]]*mean(log(claims_red$sum))
exp(coef(add_lm)[[1]]+coef(add_lm)[[2]]*mean(log(claims_red$sum)))
predict_case <- data.frame(grp = as.factor(1), sum = exp(mean(log(claims_red$sum))))
predict(add_lm, newdata = predict_case) %>% exp()
```

## Exam quizzes

### Attempt 1


#### Q5:
```{r}
car <- read.table("http://math.ku.dk/~susanne/carInsurance.txt", header = TRUE, colClasses = c("character", "factor", "factor", "integer", "integer"))
car %>% head()
```


```{r}
apply(car, 2, unique)
```

```{r}
sapply(car, levels)
```

```{r}
car <- car %>% mutate(Y = Claims/Holders)
lm_cat <- lm(Y ~ District + Motor + Age, data = car)
summary(lm_cat)
```


<!-- TEST -->

```{r}
#test
car_nonfac <- read.table("http://math.ku.dk/~susanne/carInsurance.txt", header = TRUE)
car_nonfac <- car_nonfac %>% mutate(Y = Claims/Holders)
lm_cat_nonfac <- lm(Y ~ District + Motor + Age, data = car_nonfac)
summary(lm_cat_nonfac)
```

```{r}
drop1(lm_cat, test = "F")
```


```{r}
plot(lm_cat)
ggplot(fortify(lm_cat), aes(x = .fitted, y = .stdresid)) +
  geom_point() +
  geom_smooth()
```


```{r}
beta0 <- 4.1
beta_sum <- 0.33
beta_2 <- -0.12
beta_3 <- 0.08
beta_4 <- -0.06
log10p6 <- log(10^6)
```

```{r}
sub_i <- exp(beta0 + beta_sum*log10p6 + beta_2)
sub_j <- exp(beta0 + beta_sum*log10p6 + beta_3)

sub_j/sub_i
```

```{r}

```


