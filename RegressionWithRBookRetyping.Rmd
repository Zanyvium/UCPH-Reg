---
title: "Regression with R Exercises"
author: "Victor Z. Nygaard"
abstract: |
  This document is to meant to convey the results of exercises for the UCPH masters course on Regression.
header-includes:
   - \usepackage[utf8]{inputenc}
   - \usepackage{verbatim}
   - \usepackage[language]{babel}
   - \usepackage[encoding]{inputenc}
   - \usepackage{hyperref}
   - \usepackage{amsmath}
   - \usepackage{mathtools}
   - \usepackage{amssymb}
   - \usepackage{mathtools}
   - \usepackage{nicefrac}
   - \usepackage{fullpage}
   - \usepackage{stmaryrd}
   - \usepackage{aligned-overset}
   - \usepackage{pdfpages}
date: "Last compiled on `r format(Sys.time(), '%d. %B, %Y')`"
# Hvordan får  vi den til at printe February i stedet for februar??????
output: html_document
---

------------------------------------------------------------------------

```{=html}
<!-- RMD tips:
1. CTRL+SHIFT+C RMD-comments-out the selected lines, with in a standard HTML comment-out format. 

2. CTRL+ALT+I inserts a new r codechunck

3. Pressing CTRL+SHIFT+ENTER when over a code chunck gives you a preview of the results of the chunck

4. CTRL+SHIFT+K gives you a preview of the entire resulting HTML file.

5. Note the different results of '#HS 1' and 
'# HS 1' (without the '') in the output

6. It is possible to compile regular R-scripts into Rmd files - this is done by pressing CTRL+SHIFT+K while attending any R-script. <<<- Though this apparently doesn't work for HS Problems.R for some reason!?!?!? ->>>

7. Selective use of the echo=c(...) option within code chuncks allows assignment of a variable, to show the assignment in the knitted document, and showing the value of the assignment seamlessly as well - see HS2.3

8. It is possible to include results of R-analysis such as summary statistics in LaTeX-equations in RMD, see HS2.3

9. Adding fig.align="center" to a code chunk centers any figures generated by the chunck.

9.1 note that properties of codechunks seem casesensitive; fig.align="center" centers a figure, but fig.align="Center" (with capital C) doesn't

10. A new subtitle needs a blank line before itself: 
'works:

#### HS 7
'

'doesn't:
blablabla
#### HS 7
'

'doesn't either:
<!-- blablabla ->
#### HS 7
'
11. Pressing F7 when marking, or hovering over a word will spellcheck the word

12. CTRL + - (minus) zooms out, CTRL + + (plus) zooms in

13. CTRL + D Deletes the current line, or current selection of lines

14. THE FOLLOWING SOURCE EDITOR FOLDING METHODS:
14.1 Collapse current fold: ALT + L
14.1.1: Expand current fold: SHIFT + ALT + L
14.2 Collapse "all" subfolds: ALT + O <- !?!! Note that this leaves a small letter 'o' in the text !!?!
14.2.1 Expand "all" subfolds: SHIFT + ALT + O
14.3 Collapse all other folds: ALT + 0 (zero)

15. SHIFT + ALT + J allows you to jump to specific parts of the document

16. Writing a new line with '...' will cause all previous output to be hidden in the knittet document

17. Writing (q<-5) around R code, will both assign and print the code upon assignment 

18. Note that 'attach' only has the scope of the current R-chunck.

19. One way to get pdf printout is to compile a html-printout, and then, in-browser, 'print' the HTML page as a pdf.

20. CTRL + SHIFT + M gives the pipe operator.

21. Pressing CTRL + F3 searches on the selected word.

22. CTRL

23. ALT + SHIFT + DOWN copies a line to below.

24. CTRL + ALT + K highlights all similar words in block for editing.

25. `utils::browseURL(getwd())` opens the working directory in windows explorer

26. `git commit -a -m "commit message"` as implemented within the (git) terminal (can be accessed within the git menu in RStudio via the "More" (gear icon)) commits all (-a) files within the perview of git using the message (-m) "commit message"

27. `git push` as implemented within the (git) terminal pushes the commit, as standard and when in a RProject, to the repository's main branch, unless otherwise specified.
-->
```
<!-- ---?--- How do I create a closeable Rmd section, such that I do not have to scroll through the LaTeX commands each time? - !!! Can be done with '-----' through this also creates a line in the knittet document. -->

<!-- How do I publish and share the HTML as a viewable (and linkable) website - this can be done through github? -->

<!-- How can I share R markdown files such that multiple people can edit them at the same time? -->

<!-- Do we need parindent controls as in LaTeX? -->

<!-- Use of the cache function to reduce recompile times -->

<!-- How to close current subsection with a keyboard shortcut? How to close subsubsections,...? - !!!See RMD tip 14!!! -->

<!-- Chunk naming? -->

<!-- How to define variables such that they have scope within their own ## segment? -->

<!-- How do I delete all non-needed variables for each new section in R??? -->

<!-- LaTeX commands -->

\newcommand{\C}{\mathbb{C}}

<!--- Komplekse tal --->

\newcommand{\R}{\mathbb{R}}

<!--- Reelle tal--->

\newcommand{\Q}{\mathbb{Q}}

<!---Rationelle tal--->

\newcommand{\Z}{\mathbb{Z}}

<!---Hele tal--->

\newcommand{\N}{\mathbb{N}}

<!---Naturlige tal--->

<!---mean--->

\newcommand{\F}{\mathbb{F}}

<!---Baggrundsrum sigma-alg--->

\newcommand{\B}{\mathbb{B}}

<!---Borel sigma--->

\newcommand{\K}{\mathbb{K}}

<!---Generel field--->

\newcommand{\RB}{\overline{\R}}

<!---Udvidede reelle tal--->

\newcommand{\ms}[1]{\mathscr{#1}}
\newcommand{\mc}[1]{\mathcal{#1}}

<!---Arrows -->

\newcommand{\ra}{\rightarrow}

<!---Konvergens pil højre -->

\newcommand{\nra}{\nrightarrow}

<!---ikke Konvergens pil højre -->

\newcommand{\la}{\leftarrow}

<!---Konv pil venstre -->

\newcommand{\nla}{\nleftarrow}

<!---ikke Konvergens pil venstre -->

\newcommand{\lra}{\leftrightarrow}

<!---højre venstre pil -->

\newcommand{\nlra}{\nleftrightarrow}

\newcommand{\Ra}{\Rightarrow}

<!---Implikations pil højre -->

\newcommand{\Lra}{\Leftrightarrow}

<!---Bi-implikations pil -->

\newcommand{\Uda}{\Updownarrow}

<!---Bi-implikations pil (op og ned) -->

\newcommand{\Da}{\Downarrow}

<!---implikations pil (ned) -->


\newcommand{\eqd}{\overset{d.}{=}}

<!--- Parenteser --->

\newcommand{\lrp}[1]{\mathopen{}\left({#1}\right)\mathclose{}}

<!-- \left("STUFF"\right) -->

\newcommand{\lrc}[1]{\mathopen{}\left\{{#1}\right\}\mathclose{}}

<!-- \left\{"STUFF"\right\} -->

\newcommand{\lrs}[1]{\mathopen{}\left[{#1}\right]\mathclose{}}

<!-- \left["STUFF"\right] -->

\newcommand{\lrb}[1]{\mathopen{}\left|{#1}\right|\mathclose{}}

<!-- \left|"STUFF"\right| -->

\newcommand{\inner}[2]{\mathopen{}\left\langle #1, #2 \right\rangle\mathclose{}}

<!-- <\left"STUFF1","STUFF2"\right> -->

\newcommand{\norm}[1]{\mathopen{}\left\lVert#1\right\rVert\mathclose{}}

<!-- \left||"STUFF"\right|| -->

\newcommand{\floor}[1]{\lfloor #1 \rfloor}

<!---Floor function --->

\newcommand{\ceil}[1]{\lceil #1 \rceil}

<!---ceil --->

\newcommand{\ep}{\varepsilon}

<!-- \newcommand{\Rlogo}{![](../Data/R_logo.png){#id .class width=auto height=16px} } <!-- R logo implemented in text -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(fig.align = 'center')
options(warnPartialMatchDollar = TRUE) #see ADV-R chapter 4.3.2
library(tidyverse)
library(gridExtra)
theme_set(theme_bw())
library(MASS) #Has a conflict with dplyr regarding select.
library(reshape2)
library(caret) #Used for Machine Learning
#library(plot.matrix) 
library(Matrix)
library(expm)
#library(plotly) #for 3D plotting
#library(reticulate) #Used for saving plotly images
#library(nloptr) #optimisation
#library(lpSolve) #linear programming
library(microbenchmark)
library(scales) #used for log trans of ggplot
#library(stats4) #mle and stuff

## warnings when calling functions present in multiple namespaces
## use conflict_scout() to scout conflicts in current session
library(conflicted)
conflict_prefer(name = "select",
                winner = "dplyr",
                losers = "MASS")   ## Prefer dplyr::select over MASS::select


### For Regression course:
library(ggplot2)   ## Grammar of graphics
library(reshape)   ## Reshaping data frame
library(lattice)   ## More graphics
library(hexbin)    ## and more graphics
library(gridExtra) ## ... and more graphics (placing graphs adjacent)
library(latex2exp) ## ... (allows for placing latex symbols in ggplot)
library(xtable)    ## LaTeX formatting of tables
library(splines)   ## Splines
library(survival)  ## Survival analysis
library(grid)      ## For `unit`
library(lpSolve)   ## Linear programming
library(RwR)       ## Regression with R package

set.seed(314)
```

# Chapter 2: The linear model

```{r}
claims <- read.table(
  "http://www.math.ku.dk/~richard/regression/data/claims.txt", 
  sep = ";",
  colClasses = c("character", "numeric", "numeric", "factor")
)
```

```{r}
head(claims)
claims %>% tail()
```

```{r}
p0 <- qplot(sum, claims, data = claims, alpha = I(0.2)) +
  scale_x_log10("Insurance sum (DKK)", 
                breaks = 10^c(6, 7, 8),
                labels = c("1M", "10M", "100M")) +
  scale_y_log10("Claim size (DKK)", 
                breaks = 10^c(2, 4, 6, 8),
                labels = c("100", "10k", "1M", "100M"))
(p <- p0 + geom_smooth(method = "lm", linewidth = 1.5, se = FALSE))
```

```{r}
p + facet_wrap(~ grp, ncol = 4)
```

```{r}
claimsLm <- lm(I(log(claims)) ~ I(log(sum)), data = claims)
summary(claimsLm)
coefficients(claimsLm)
```

```{r}
model.matrix(claimsLm)[781:784,]
```

```{r}
claimsLmAddUnres <- lm(I(log(claims)) ~ I(log(sum)) + grp, data = claims)
summary(claimsLmAddUnres)
coefficients(claimsLmAddUnres)
```

```{r}
model.matrix(claimsLmAddUnres)[781:784, ]
```

```{r}
claimsLmAdd <- lm(I(log(claims)) ~ I(log(sum)) + grp, data = claims,
                                      contrasts = list(grp = "contr.sum"))

summary(claimsLmAdd)
coefficients(claimsLmAdd)
```

```{r}
model.matrix(claimsLmAdd)[781:784, ]
```

```{r}
claimsLmInt <- lm(I(log(claims)) ~ I(log(sum)) * grp, data = claims)
claimsLmInt %>% summary
claimsLmInt %>% coefficients
```

```{r}
model.matrix(claimsLmInt)[781:784, ]
```

```{r}
claimsDiagnos <- fortify(claimsLm)
claimsDiagnos %>% head()
```
<!-- changing to the naming syntax of the tidyverse style guide https://style.tidyverse.org/syntax.html -->

```{r}
claims_diagnos_add <- fortify(claimsLmAdd)
claims_diagnos_add %>% head()
```

```{r}
claims_diagnos_int <- fortify(claimsLmInt)
claims_diagnos_int %>% head()
```


```{r}
grid.arrange(
  qplot(.fitted, .resid, data = claimsDiagnos, alpha = I(0.2)) +
    geom_smooth(),
  qplot(.resid, data = claimsDiagnos, bins = I(40)),
  qplot(sample = .stdresid, data = claimsDiagnos, geom = "qq") +
          geom_abline(),
  ncol = 3, top = "basic model"
)
```

```{r}
grid.arrange(
  qplot(.fitted, .resid, data = claims_diagnos_add, alpha = I(0.2)) +
    geom_smooth(),
  qplot(.resid, data = claims_diagnos_add, bins = I(40)),
  qplot(sample = .stdresid, data = claims_diagnos_add, geom = "qq") +
          geom_abline(),
  ncol = 3, top = "additive model"
)
```


```{r}
grid.arrange(
  qplot(.fitted, .resid, data = claims_diagnos_int, alpha = I(0.2)) +
    geom_smooth(),
  qplot(.resid, data = claims_diagnos_int, bins = I(40)),
  qplot(sample = .stdresid, data = claims_diagnos_int, geom = "qq") +
          geom_abline(),
  ncol = 3, top = "interaction model"
)
```


```{r}
anova(claimsLm, claimsLmAdd, claimsLmInt)
```

```{r}
claims_lm_spline_add <- lm(I(log(claims)) ~ ns(log(sum), knots = c(13,15,17,19))
                           + grp,
                           data = claims)

claims_lm_spline_int <- lm(I(log(claims)) ~ ns(log(sum), knots = c(13,15,17,19))
                           * grp,
                           data = claims)
```

```{r}
summary(claims_lm_spline_add)
```

```{r}
summary(claims_lm_spline_int)
```

```{r}
claims_diagnos_spline_add <- fortify(claims_lm_spline_add)
claims_diagnos_spline_add %>% head()
```

```{r}
claims_diagnos_spline_int <- fortify(claims_lm_spline_int)
claims_diagnos_spline_int %>% head()
```

```{r}
grid.arrange(
  qplot(.fitted, .resid, data = claims_diagnos_spline_add, alpha = I(0.2)) +
    geom_smooth(),
  qplot(.resid, data = claims_diagnos_spline_add, bins = I(40)),
  qplot(sample = .stdresid, data = claims_diagnos_spline_add, geom = "qq") +
          geom_abline(),
  ncol = 3, top = "additive spline model"
)
```

```{r}
grid.arrange(
  qplot(.fitted, .resid, data = claims_diagnos_spline_int, alpha = I(0.2)) +
    geom_smooth(),
  qplot(.resid, data = claims_diagnos_spline_int, bins = I(40)),
  qplot(sample = .stdresid, data = claims_diagnos_spline_int, geom = "qq") +
          geom_abline(),
  ncol = 3, top = "interaction spline model"
)
```
We may plot the splines used:
```{r}
# Here the conflicted package makes an error, as melt is ambiguous between
# reshape::melt and reshape2::melt

# ns_tibble <- ns(log(claims$sum), knots = c(13,15,17,19)) %>%
#   as_tibble() %>%
#   rename_with(~ paste0("ns_", .), recycle0 = TRUE) %>%
#   mutate(log_sum = log(claims$sum), .before = 1) %>% 
#   melt(id.vars = c("log_sum"))
```

```{r}
# We thus force a specification:
conflicts_prefer(reshape2::melt)

ns_tibble <- ns(log(claims$sum), knots = c(13,15,17,19)) %>%
  as_tibble() %>%
  rename_with(~ paste0("ns_", .), recycle0 = TRUE) %>%
  mutate(log_sum = log(claims$sum), .before = 1) %>% 
  melt(id.vars = c("log_sum"), 
       variable.name = "spline",
       value.name = "spline_value") %>% 
  select(c("log_sum", "spline_value", "spline")) #reorder columns
ns_tibble %>% head()
```

```{r}
ns_tibble %>%
  ggplot(mapping = aes(x = log_sum, y = as.numeric(spline_value), colour = spline)) + 
  geom_line() + 
  labs(colour = "Spline",
       x = "log sum",
       y = "spline value",
       title = "Natural spline basis-functions used in models.")
```

```{r}
pred_add <- cbind(claims, exp(predict(claims_lm_spline_add,
                                     interval = "confidence")))
pred_add %>% head()
pred_int <- cbind(claims, exp(predict(claims_lm_spline_int,
                                     interval = "confidence")))

p0 <- p0 + facet_wrap(~ grp, ncol = 4) + 
  coord_cartesian(ylim = c(1e2, 1e6))

p0 + geom_line(data = pred_add,
               mapping = aes(y = fit),
               colour = "blue",
               size = 2) +
  geom_ribbon(data = pred_add,
              mapping = aes(ymax = upr, ymin = lwr),
              fill = "blue",
              alpha = 0.2) +
  geom_line(data = pred_int,
            mapping = aes(y = fit),
            colour = "red",
            size = 2) +
  geom_ribbon(data = pred_int,
              mapping = aes(ymax = upr, ymin = lwr),
              fill = "red",
              alpha = 0.2)
  

```

```{r}
anova(claimsLmAdd, claims_lm_spline_add, claims_lm_spline_int)
```

```{r}
# prefer dplyr::rename over reshape::rename
conflicted::conflicts_prefer(dplyr::rename)

X <- model.matrix(claims_lm_spline_int)
y <- model.response(model.frame(claims_lm_spline_int))

XtX <- crossprod(X)   ## Faster than but equivalent to t(X) %*% X
Xty <- crossprod(X,y) ## Faster than but equivalent to t(X) %*% y

coefHat <- solve(XtX, Xty)
range(coefHat - coefficients(claims_lm_spline_int))
```

<!-- ??? Below doesn't work -->
<!-- model.frame(claims_lm_spline_int) %>% -->
<!--   select(across(starts_with("ns"))) %>% head() -->
<!--   rename(paste0("ns_",1:5), 2:6) %>% -->
<!--   head() -->

```{r}
Omega <- diag(c(rep(0, 9), rep(1, 15)))
coefHat <- cbind(solve(XtX + 0.1 * Omega, Xty),
                 solve(XtX + 1 * Omega, Xty),
                 solve(XtX + 10 * Omega, Xty))
```


```{r}
# Using TeX from the latex2exp package
tmp <- cbind(coefficients(claims_lm_spline_int),
                          coefHat, 
                          c(coefficients(claims_lm_spline_add), rep(0, 15)))
pred <- cbind(claims[,c("sum", "grp")], exp(X %*% tmp)) %>%
  melt(id.vars = c("grp", "sum"))
p0 + geom_line(data = pred, aes(y = value, colour = variable), size = 2) +
  theme(legend.position = "top") +
  scale_colour_discrete(TeX("$\\lambda$"), 
                        labels = c("0", "0.1",
                                   "1", "10",
                                   TeX("$\\infinity$ (additive model)")))
```

```{r}
fit_lamb_1 <- lm.fit(rbind(X, sqrt(0.1) * Omega),
                     c(y, rep(0, ncol(Omega))))
#fit_lamb_1 %>% summary()
fit_lamb_2 <- lm.fit(rbind(X, sqrt(1) * Omega),
                     c(y, rep(0, ncol(Omega))))
fit_lamb_3 <- lm.fit(rbind(X, sqrt(10) * Omega),
                     c(y, rep(0, ncol(Omega))))

## comparisons
range(coefHat[, 1] - coefficients(fit_lamb_1))
range(coefHat[, 2] - coefficients(fit_lamb_2))
range(coefHat[, 3] - coefficients(fit_lamb_3))
```

# Chapter 3: Birth weight - a case study

We read in the data:
```{r}
pregnant <- RwR::pregnant
```

and take a look at it:
```{r}
head(pregnant)
summary(pregnant)
```

noting some unrealistically extreme values of `0` and `99` from `length` and `0` in weight, we exclude these cases from the subsequent analysis, as done in the book. While the book doesn't motivate its exclusion of `interviewWeek` as a predictor, we might note that given the job is to introduce

```{r}
pregnant <- pregnant %>% subset(weight > 32 &
                                length > 10 &
                                length < 99 &
                                gestationalAge > 18,
                                select = -c(interviewWeek, fetalDeath))
```


list of issues one should be aware of includes, but is not limited to

1. Extreme observations

2. Missing values

3. skewness or asymmetry of marginal distributions

4. co-linear covariates.


We may plot the marginal distribution of various of the numerical variables with decent variation within them.
Note the use of the `drop = FALSE` argument, which ensures preservation of the dimensionality and class of the columns of the data
```{r}
tmp <- lapply(names(pregnant), function(x)
  ggplot(data = pregnant[, x, drop = FALSE]) + 
    aes_string(x) + xlab(x) + ylab(""))
gd <- geom_density(adjust = 2, fill = grey(0.5))
gb <- geom_bar(fill = grey(0.5))
grid.arrange(
  tmp[[1]] + gd,
  tmp[[4]] + gb,
  tmp[[6]] + gb,
  tmp[[8]] + gd,
  tmp[[9]] + gd,
  ncol = 5
)
```

```{r}
grid.arrange(
  tmp[[2]] + gb,
  tmp[[3]] + gb,
  tmp[[5]] + gb,
  tmp[[7]] + gb,
  tmp[[10]] + gb +
    aes(x = factor(feverEpisodes)) +
    xlab("feverEpisodes"),
  ncol = 5
)
```


```{r}
cor.print <- function(x,y) {
  panel.text(mean(range(x)), mean(range(y)),
             TeX(paste0('$', round(cor(x,y), digits = 2), '$')))
}
cont_var <- c("age", "gestationalAge", "alcohol", "length", "weight")
splom(na.omit(pregnant)[, cont_var],
              xlab = "",
              upper.panel = panel.hexbinplot,
              pscales = 0,
              xbins = 20,
              varnames = c("age", "gest. age", cont_var[3:5]),
              lower.panel = cor.print)
```


```{r}
cp <- cor(data.matrix(na.omit(pregnant)), method = "spearman")
ord <- rev(hclust(as.dist(1-abs(cp)))$order)
col_pal <- colorRampPalette(c("blue", "yellow"), space = "rgb")(100)

levelplot(cp[ord, ord],
          xlab = "",
          ylab = "",
          col.regions = col_pal,
          at = seq(-1,1, length.out = 100),
          colorkey = list(space = "top", labels = list(cex = 1.5)),
          scales = list(x = list(rot = 45),
                        y = list(draw = FALSE),
                        cex = 1.2))
```


```{r}
m_pregnant <- melt(pregnant[, c("weight",
                               "abortions",
                               "children",
                               "smoking",
                               "coffee",
                               "feverEpisodes")],
                   id = "weight")
m_pregnant %>% ggplot(aes(x = factor(value, level = 0:10), y = weight)) +
  geom_boxplot(fill = I(grey(0.8))) +
  xlab("") +
  facet_wrap(~ variable, scale = "free_x", ncol = 5)
```

```{r}
form <- weight ~ gestationalAge + length + age + children + coffee +
  alcohol + smoking + abortions + feverEpisodes
pregnant <- na.omit(pregnant)
nul_model <- lm(weight ~ 1, data = pregnant)
one_term_models <- add1(nul_model, form, test = "F")
```

```{r}
m_pregnant <- melt(pregnant[, cont_var], 
                   id.vars = "weight")
bin_scale <- scale_fill_continuous(breaks = c(1, 10, 100, 1000),
                                   low = "grey80",
                                   high = "black",
                                   trans = "log",
                                   guide = "none")
m_pregnant %>% ggplot(aes(x = value, y = weight)) +
  geom_hex(bins = 20) + 
  bin_scale +
  xlab("") +
  facet_wrap(~ variable, scales = "free_x", ncol = 4) +
  geom_smooth(size = 1, method = "lm")
```

```{r}
one_term_models
```


```{r}
### update the form to be as it were, regressing the response (weight) on the 
### original predictors, but now without length.
form <- update(form, . ~ . - length) 
pregnant_lm <- lm(form, data = pregnant)
summary(pregnant_lm)
```

```{r}
drop1(pregnant_lm, test = "F")
```

```{r}
pregnant_diag <- fortify(pregnant_lm)
p1 <- pregnant_diag %>% ggplot(aes(x = .fitted, y = .stdresid)) + 
  geom_hex() +
  geom_smooth(size = 1) +
  bin_scale +
  xlab("fitted values") +
  ylab("standarised residuals")
p2 <- pregnant_diag %>% ggplot(aes(x = gestationalAge, y = .stdresid)) + 
  geom_hex(bins = 20) +
  geom_smooth(size = 1) +
  bin_scale +
  xlab("gestationalAge") +
  ylab("")
p3 <- pregnant_diag %>% ggplot() + 
  geom_qq(mapping = aes(sample = .stdresid)) +
  geom_abline(intercept = 0, slope = 1, colour = "blue", size = 1) +
  xlab("theoretical quantiles") +
  ylab("")
grid.arrange(p1, p2, p3, ncol = 3)
```

Note the use of `facet_grid` instead of `facet_wrap`
```{r}
pregnant %>% ggplot(aes(gestationalAge, weight)) +
  geom_hex(bins = 20) +
  bin_scale +
  geom_smooth(method = "lm", size = 1, se = FALSE) +
  facet_grid(coffee ~ children + smoking, labeller = label_both)
```

```{r}
form <- weight ~ smoking * coffee * children * gestationalAge + age +
  alcohol + abortions + feverEpisodes
pregnant_lm_2 <- lm(form, data = pregnant)
anova(pregnant_lm, pregnant_lm_2)
```
```{r}
pregnant %>% ggplot(aes(gestationalAge, weight, colour = coffee)) +
  facet_grid(. ~ children + smoking, label = label_both) +
  geom_smooth(method = "lm", size = 1, se = FALSE)
```

```{r}
pregnant_diag_2 <- fortify(pregnant_lm_2)
pregnant_diag_2 %>% ggplot(aes(.fitted, .stdresid)) +
  geom_hex() +
  bin_scale +
  geom_smooth(size = 1) +
  xlab("fitted values") +
  ylab("standardised residuals")
```

```{r}
form <- weight ~ smoking * coffee * children * gestationalAge
pregnant_lm_3 <- lm(form, data = pregnant)
anova(pregnant_lm_3, pregnant_lm_2)
```

```{r}
pregnant_diag_3 <- fortify(pregnant_lm_3)
p1 <- pregnant_diag_3 %>% ggplot(aes(x = .fitted, y = .stdresid)) + 
  geom_hex() +
  geom_smooth(size = 1) +
  bin_scale +
  xlab("fitted values") +
  ylab("standarised residuals")
p2 <- pregnant_diag_3 %>% ggplot(aes(x = gestationalAge, y = .stdresid)) + 
  geom_hex(bins = 20) +
  geom_smooth(size = 1) +
  bin_scale +
  xlab("gestationalAge") +
  ylab("")
p3 <- pregnant_diag_3 %>% ggplot() + 
  geom_qq(mapping = aes(sample = .stdresid)) +
  geom_abline(intercept = 0, slope = 1, colour = "blue", size = 1) +
  xlab("theoretical quantiles") +
  ylab("")
grid.arrange(p1, p2, p3, ncol = 3)
rm(p1,p2,p3)
```



```{r}
nsg <- function(x) {
  ns(x, knots = c(38,40,42), Boundary.knots = c(25, 47))
}
form <- weight ~ nsg(gestationalAge) + ns(age, df = 3) + children + coffee + alcohol + smoking + abortions + feverEpisodes
pregnant_lm_4 <- lm(form, data = pregnant)
anova(pregnant_lm, pregnant_lm_4)
```




```{r}
library(rlang)
###!!! In theory we don't need to get the lm names in the beginning, 
###!!! but could simply allow for possible swap and then deparse
###!!! this however for some reason doesn't go too well.

# check_nested_old <- function(lm_1, lm_2) {
#   ### Checks whether lm_1 and lm_2 are nested
#   ### using RwR exercise 2.1
#   lm_1_name <- deparse(substitute(lm_1))
#   lm_2_name <- deparse(substitute(lm_2))
#   if(lm_2$df.residual<lm_1$df.residual) {
#     # Swaps the models if lm_2 has used
#     # more degrees of freedom than lm_1
#     # So as to fit with the correct 
#     # model matrices below
#     lm_2_tmp <- lm_2
#     lm_2_name_tmp <- lm_2_name
#     lm_2 <- lm_1
#     lm_2_name <- lm_1_name
#     lm_1 <- lm_2_tmp
#     lm_1_name <- lm_2_name_tmp
#     rm(lm_2_tmp)
#     rm(lm_2_name_tmp)
#   }
#   X <- model.matrix(lm_1)
#   Xp <- model.matrix(lm_2)
#   #C <- solve(t(X)%*%X)%*%t(X)%*%Xp  
#   C <- tcrossprod(solve(crossprod(X,X)),X)%*%Xp
#   range_xmxpc <- range(Xp-X%*%C)
#   cat("Range of X' - XC\n",
#       range_xmxpc,
#       "\n", lm_2_name, "included in", lm_1_name, ":",
#       range_xmxpc[1]<0 && abs(range_xmxpc[1])<1e-8 &&
#         range_xmxpc[2]>0 && abs(range_xmxpc[2])<1e-8)
# }


check_nested <- function(lm_1, lm_2) {
  ### Checks whether lm_1 and lm_2 are nested
  ### using RwR exercise 2.1
  lm_1_name <- deparse(substitute(lm_1))
  lm_2_name <- deparse(substitute(lm_2))
  if(lm_2$df.residual<lm_1$df.residual) {
    X <- model.matrix(lm_2)
    Xp <- model.matrix(lm_1)
    lm_2_name_tmp <- lm_2_name
    lm_2_name <- lm_1_name
    lm_1_name <- lm_2_name_tmp
    rm(lm_2_name_tmp)
  } else {
    X <- model.matrix(lm_1)
    Xp <- model.matrix(lm_2)
  }
  #C <- solve(t(X)%*%X)%*%t(X)%*%Xp  
  C <- tcrossprod(solve(crossprod(X,X)),X)%*%Xp
  range_xmxpc <- range(Xp-X%*%C)
  cat("Range of X' - XC\n",
      range_xmxpc,
      "\n", lm_2_name, "nested in", lm_1_name, ":",
      range_xmxpc[1]<0 && abs(range_xmxpc[1])<1e-8 &&
        range_xmxpc[2]>0 && abs(range_xmxpc[2])<1e-8)
}
```

```{r}
check_nested(pregnant_lm,  pregnant_lm_4)
```

```{r warning=FALSE, message=FALSE}
pregnant_diag_4 <- fortify(pregnant_lm_4) %>% mutate(gestationalAge = pregnant$gestationalAge)
p1 <- pregnant_diag_4 %>% ggplot(aes(x = .fitted, y = .stdresid)) + 
  geom_hex() +
  geom_smooth(size = 1) +
  bin_scale +
  xlab("fitted values") +
  ylab("standarised residuals")
p2 <- pregnant_diag_4 %>% ggplot(aes(x = gestationalAge, y = .stdresid)) + 
  geom_hex(bins = 20) +
  geom_smooth(size = 1) +
  bin_scale +
  xlab("gestationalAge") +
  ylab("")
p3 <- pregnant_diag_4 %>% ggplot() + 
  geom_qq(mapping = aes(sample = .stdresid)) +
  geom_abline(intercept = 0, slope = 1, colour = "blue", size = 1) +
  xlab("theoretical quantiles") +
  ylab("")
grid.arrange(p1, p2, p3, ncol = 3)
rm(p1,p2,p3)
```


```{r}
form <- weight ~ nsg(gestationalAge) + children + coffee + smoking
pregnant_lm_5 <- lm(form, data = pregnant)
anova(pregnant_lm_5, pregnant_lm_4)
```

```{r}
pred_frame <- expand.grid(children = factor(1),
                          smoking = factor(c(1, 3)),
                          coffee = factor(c(1, 3)),
                          gestationalAge = seq(25, 47, 0.01),
                          alcohol = 0,
                          age = median(pregnant$age),
                          feverEpisodes = 0,
                          abortions = factor(0))
pred_frame %>% head()
pred_gest <- predict(pregnant_lm_4, newdata = pred_frame, interval = "confidence")
pred_frame <- cbind(pred_frame, pred_gest)
pred_frame %>% 
  ggplot(aes(gestationalAge, fit)) +
  geom_line(aes(colour = coffee)) +
  ylab("weight") +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = coffee), alpha = 0.3) +
  facet_grid(. ~ smoking, label = label_both) + ggtitle("pregnant_lm_4")
```

```{r}
pred_frame <- expand.grid(children = factor(1),
                          smoking = factor(c(1, 3)),
                          coffee = factor(c(1, 3)),
                          gestationalAge = seq(25, 47, 0.01),
                          alcohol = 0,
                          age = median(pregnant$age),
                          feverEpisodes = 0,
                          abortions = factor(0))
pred_gest <- predict(pregnant_lm_5, newdata = pred_frame, interval = "confidence")
pred_frame <- cbind(pred_frame, pred_gest)
pred_frame %>% 
  ggplot(aes(gestationalAge, fit)) +
  geom_line(aes(colour = coffee)) +
  ylab("weight") +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = coffee), alpha = 0.3) +
  facet_grid(. ~ smoking, label = label_both) + ggtitle("pregnant_lm_5")
```

```{r}
form <- weight ~ (smoking + coffee + children) * nsg(gestationalAge) +
  ns(age, df = 3) + alcohol + abortions + feverEpisodes
pregnant_lm_6 <- lm(form, data = pregnant)
anova(pregnant_lm_5, pregnant_lm_6)
```
```{r}
pred_frame <- expand.grid(children = factor(c(0, 1)),
                          smoking = factor(c(1, 2, 3)),
                          coffee = factor(c(1, 2, 3)),
                          gestationalAge = 25:47,
                          alcohol = 0,
                          age = median(pregnant$age),
                          feverEpisodes = 0,
                          abortions = factor(0))
pred_frame <- cbind(pred_frame, predict(pregnant_lm_6,  newdata = pred_frame, interval = "confidence"))
pred_frame$fit5 <- predict(pregnant_lm_5, newdata = pred_frame)
pred_frame %>% ggplot(aes(gestationalAge, fit)) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = grey(0.85)) + 
  geom_line(colour = "red") +
  geom_line(aes(y = fit5), colour = "blue") +
  facet_grid(coffee ~ children + smoking, label = label_both) +
  coord_cartesian(ylim = c(0,5000)) +
  scale_y_continuous(breaks = c(1000, 2000, 3000, 4000))
```


# Chapter 4: Data analysis with regression models


# Chapter 5: Exponential dispersion models


# Chapter 6: Generalised linear models


# Chapter 7: Advertising - a case study


# Chapter 8: Existence and uniqueness


# Chapter 9: Model assessment


# Chapter 10: Interval estimation


# Chapter 11: Survival analysis

